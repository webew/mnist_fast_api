from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi import Request
import numpy as np 
from tensorflow.keras.models import load_model

# Créer une instance FastAPI
app = FastAPI()

# Configuration de CORS pour autoriser les requêtes provenant de http://127.0.0.1:5500
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://127.0.0.1:5500"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Définir une route
@app.get('/')
def read_root():
    return {'Hello': 'World'}

@app.get('/test_param')
def test_param(name: str):
    return {'name': name}

# Route pour traiter les données JSON
@app.post("/process_data")
async def process_data(request: Request):
    data = await request.json()
    # data_scaled = data / 255;
    # Traitement des données JSON reçues
    # data = np.array(data)
    
    data_scaled_reshaped = scale_and_reshape(data)
    print("ok")  
    print(data)  # Afficher les données reçues dans la console du serveur
    print(data_scaled_reshaped)  # Afficher les données reçues dans la console du serveur
    # model = load_model('mon_mnist.h5')
    # prediction = model.predict(data_scaled_reshaped)
    # value = int(np.argmax(prediction, axis=1)[0])
    value = predict(data_scaled_reshaped)
    print(value)
    return value
    # print(value)
    # return value

def scale_and_reshape(data):
    data_scaled = []
    for line in data:
        new_line = []
        for value in line:
            new_line.append(value / 255)
        data_scaled.append(new_line)
    data_scaled = np.array(data_scaled)
    data_scaled_reshaped = data_scaled.reshape(1,28,28,1)
    return data_scaled_reshaped

def predict(data_scaled_reshaped):
    model = load_model('mon_mnist.h5')
    prediction = model.predict(data_scaled_reshaped)
    return int(np.argmax(prediction, axis=1)[0])

# def predict2(data_scaled_reshaped):
#     data = [[0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.01176471, 0.07058824, 0.07058824,
#         0.07058824, 0.49411765, 0.53333333, 0.68627451, 0.10196078,
#         0.65098039, 1.        , 0.96862745, 0.49803922, 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.11764706, 0.14117647,
#         0.36862745, 0.60392157, 0.66666667, 0.99215686, 0.99215686,
#         0.99215686, 0.99215686, 0.99215686, 0.88235294, 0.6745098 ,
#         0.99215686, 0.94901961, 0.76470588, 0.25098039, 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.19215686, 0.93333333, 0.99215686,
#         0.99215686, 0.99215686, 0.99215686, 0.99215686, 0.99215686,
#         0.99215686, 0.99215686, 0.98431373, 0.36470588, 0.32156863,
#         0.32156863, 0.21960784, 0.15294118, 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.07058824, 0.85882353, 0.99215686,
#         0.99215686, 0.99215686, 0.99215686, 0.99215686, 0.77647059,
#         0.71372549, 0.96862745, 0.94509804, 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.31372549, 0.61176471,
#         0.41960784, 0.99215686, 0.99215686, 0.80392157, 0.04313725,
#         0.        , 0.16862745, 0.60392157, 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.05490196,
#         0.00392157, 0.60392157, 0.99215686, 0.35294118, 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.54509804, 0.99215686, 0.74509804, 0.00784314,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.04313725, 0.74509804, 0.99215686, 0.2745098 ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.1372549 , 0.94509804, 0.88235294,
#         0.62745098, 0.42352941, 0.00392157, 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.31764706, 0.94117647,
#         0.99215686, 0.99215686, 0.46666667, 0.09803922, 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.17647059,
#         0.72941176, 0.99215686, 0.99215686, 0.58823529, 0.10588235,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.0627451 , 0.36470588, 0.98823529, 0.99215686, 0.73333333,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.97647059, 0.99215686, 0.97647059,
#         0.25098039, 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.18039216,
#         0.50980392, 0.71764706, 0.99215686, 0.99215686, 0.81176471,
#         0.00784314, 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.15294118, 0.58039216, 0.89803922,
#         0.99215686, 0.99215686, 0.99215686, 0.98039216, 0.71372549,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.09411765, 0.44705882, 0.86666667, 0.99215686, 0.99215686,
#         0.99215686, 0.99215686, 0.78823529, 0.30588235, 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.09019608, 0.25882353,
#         0.83529412, 0.99215686, 0.99215686, 0.99215686, 0.99215686,
#         0.77647059, 0.31764706, 0.00784314, 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.07058824, 0.67058824, 0.85882353, 0.99215686,
#         0.99215686, 0.99215686, 0.99215686, 0.76470588, 0.31372549,
#         0.03529412, 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.21568627,
#         0.6745098 , 0.88627451, 0.99215686, 0.99215686, 0.99215686,
#         0.99215686, 0.95686275, 0.52156863, 0.04313725, 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.53333333,
#         0.99215686, 0.99215686, 0.99215686, 0.83137255, 0.52941176,
#         0.51764706, 0.0627451 , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ],
#        [0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        , 0.        , 0.        ,
#         0.        , 0.        , 0.        ]]
#     return "ok"

# Exécuter l'application avec Uvicorn
# Lancez votre application en exécutant la commande suivante dans votre terminal :
# uvicorn main:app --reload
# Cela démarre un serveur de développement sur http://127.0.0.1:8000 par défaut
